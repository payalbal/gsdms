---
title: "GBIF data cleaning"
description: "Master script file for global SDMs for the ARC Trade-Biodiversity project"
author: "Payal Bal"
collaborators: "Casey Visintin"
date: "`r Sys.Date()`"
output: html_document
Acompanying R script files: "1_gbif_db_processing.R"
gbif data citation: "GBIF.org (12th December 2017) GBIF Occurrence Download https://doi.org/10.15468/dl.kaciwi" 
---

<!-- Specify global options for code chunks -->
```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = FALSE)
```

```{r load packages, eval=TRUE, echo=FALSE}
library(pacman)
p_load(DBI, RPostgreSQL, data.table, rgbif, foreach, 
       iterators, parallel, doParallel, doMC)
```


## Connect to server
<!-- <span style="color:blue">Issue: Prompt for server details here</span> -->

```{r connect to server, eval=FALSE, echo=TRUE}
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname="", user="", password="", host="", port="")
```
```{r connect to server2, eval=TRUE, echo=FALSE}
drv <- dbDriver("PostgreSQL") ## specify driver for postgreSQL database
con <- dbConnect(drv, dbname="", user="", password="", host="", port="")
```


## Count occurrence records in GBIF database
Number of records in the online gbif database as of `r Sys.Date()`*:*
```{r count gbif online, eval=TRUE, echo=FALSE}
occ_count()
```
See here: https://www.gbif.org/occurrence/search
 
Number of records in the raw gbif database downloaded (as.csv and upload on server) on 2017-12-12:<br/>
  - equal to number of rows in gbif.raw_data on server<br/>
  - count obtained from db metadata
```{r count rows gbif.raw_data, eval=TRUE, echo=FALSE}
dbGetQuery(con,"SELECT reltuples::bigint AS estimate
                FROM   pg_class
                WHERE  oid = 'gbif.raw_data'::regclass;
                ")
```
  
Size of raw gbif database (see citation above)
```{r size gbif.raw_data, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
              SELECT pg_size_pretty(pg_relation_size('gbif.raw_data'));
              ")
```


## Data cleaning
#### Run first filter
  - raw database: gbif.raw_data
  - new database: gbif.filtered

```{r first filter, eval=FALSE, echo=TRUE}
## Run query for first filter and create new table
dbSendQuery(con,"
            CREATE TABLE gbif.filtered AS
            SELECT
              gbifid,
              occurrenceid, 
              species,
              scientificname,
              countrycode,
              decimallatitude,
              decimallongitude,
              coordinateuncertaintyinmeters,
              coordinateprecision,
              elevation,
              elevationaccuracy,
              \"depth\",
              depthaccuracy,
              eventdate,
              \"year\",
              taxonkey,
              phylum,
              \"class\",
              \"order\",
              \"family\",
              genus,
              specieskey,
              basisofrecord,
              issue
            FROM gbif.raw_data
            WHERE kingdom = 'Animalia'
            AND year BETWEEN '1950' AND '2018'
            AND basisofrecord IN ('HUMAN_OBSERVATION','PRESERVED_SPECIMEN', 'OBSERVATION', 'MATERIAL_SAMPLE', 'MACHINE_OBSERVATION');

            ALTER TABLE gbif.filtered
            RENAME COLUMN \"depth\" TO recdepth;
            ALTER TABLE gbif.filtered
            RENAME COLUMN \"year\" TO recyear;
            ALTER TABLE gbif.filtered
            RENAME COLUMN \"class\" TO taxclass;
            ALTER TABLE gbif.filtered
            RENAME COLUMN \"order\" TO taxorder;
            ALTER TABLE gbif.filtered
            RENAME COLUMN \"family\" TO taxfamily;
            ") 
```

Number of records in new database <br/>
  - equal to number of rows in gbif.first_filter<br/>
  - count obtained from db metadata
```{r count gbif.filtered, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
                SELECT reltuples::bigint AS estimate
                FROM   pg_class
                WHERE  oid = 'gbif.filtered'::regclass;
                ")
```

Size of new gbif database
```{r size gbif.filtered, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
              SELECT pg_size_pretty(pg_relation_size('gbif.filtered'));
              ")
```

#### Get column names for new database
```{r column names, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
           SELECT column_name 
           FROM information_schema.columns 
           WHERE table_schema = 'gbif'
           AND table_name = 'filtered';
           ")$column_name
```

#### Convert empty characters in gbif.filtered to NULL
<!-- <span style="color:blue">Issue: Prompt for server details here</span> -->

```{r empty to null, eval=FALSE, echo=TRUE}
dbGetQuery(con,"
               SELECT column_name 
               FROM information_schema.columns 
               WHERE table_schema = 'gbif'
               AND table_name = 'filtered';
               ")$column_name

registerDoMC(30)
foreach (i=gbif.fields) %dopar% { 
  drv <- dbDriver("PostgreSQL")
  con <- dbConnect(drv, dbname="", user="", 
                   password="", host="", port="")
  dbSendQuery(con, paste("UPDATE gbif.filtered SET ",i," = NULL WHERE ",i,
                         "::char = '';", sep=""))
}
```


#### Discard records with NULL values for 'species' or 'scientificname'
```{r discard null species, eval=FALSE, echo=TRUE}
dbSendQuery(con,"
            DELETE FROM gbif.filtered
            WHERE species IS NULL
            OR scientificname IS NULL;
            ")
```

#### Discard records with NULL lat long values
```{r discard null lat-long, eval=FALSE, echo=TRUE}
dbSendQuery(con,"
            DELETE FROM gbif.filtered
            WHERE decimallatitude IS NULL
            OR decimallongitude IS NULL;
            ")
```

#### Convert lat and long to numeric
```{r numeric lat-long, eval=FALSE, echo=TRUE}
dbSendQuery(con,"
            ALTER TABLE gbif.filtered 
            ALTER COLUMN decimallatitude TYPE NUMERIC USING decimallatitude::numeric;
            ")

dbSendQuery(con,"
            ALTER TABLE gbif.filtered
            ALTER COLUMN decimallongitude TYPE NUMERIC USING decimallongitude::numeric;
            ")
```

#### Set primary key and index
```{r key and index, eval=FALSE, echo=TRUE}
dbSendQuery(con,"
            ALTER TABLE gbif.filtered ADD PRIMARY KEY (gbifid);
             
            ALTER TABLE gbif.filtered 
            ALTER COLUMN gbifid TYPE INTEGER USING gbifid::integer;
            
            CREATE INDEX filtered_index
            ON gbif.filtered USING btree
            (taxonkey COLLATE pg_catalog.default)
            TABLESPACE pg_default;
            ")
```



## Run checks on new database
Check size of gbif.filtered
```{r size gbif.filtered2, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
              SELECT pg_size_pretty(pg_relation_size('gbif.filtered'));
              ")
```

Check number of columns
```{r columns gbif.filtered, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
              SELECT COUNT(*) 
              FROM information_schema.columns
              WHERE table_name='filtered';
              ")
```

Check number of rows
```{r rows gbif.filtered, eval=TRUE, echo=FALSE}
dbGetQuery(con,"
              SELECT reltuples::bigint AS estimate
              FROM pg_class
              WHERE  oid = 'gbif.filtered'::regclass;
              ")
```


## Useful links
*gbif data fields* <br/>
https://www.gbif.org/developer/occurrence <br/>
http://rs.gbif.org/core/dwc_occurrence.xml

<!-- *knitr* <br/> -->
<!-- http://kbroman.org/knitr_knutshell/pages/Rmarkdown.html -->
